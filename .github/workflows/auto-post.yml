name: ðŸ¤– AI Auto Blog Posting

on:
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 9ì‹œ (UTC), í•œêµ­ì‹œê°„ ì˜¤í›„ 6ì‹œ
    - cron: '0 9 * * *'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ë²„íŠ¼ í™œì„±í™”

jobs:
  auto-blog-post:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: ðŸ Python í™˜ê²½ ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: ðŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        python -m pip install --upgrade pip
        pip install openai>=1.0.0 requests>=2.31.0 beautifulsoup4>=4.12.0
    
    - name: ðŸ¤– AI ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸ ìƒì„±
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      run: |
        cd scripts
        python auto_blogger.py
      continue-on-error: true
    
    - name: ðŸ“Š ë³€ê²½ì‚¬í•­ í™•ì¸
      id: verify-changed-files
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "ðŸ“ ìƒˆë¡œìš´ ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤."
        else
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "â„¹ï¸ ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
        fi
    
    - name: ðŸ’¾ ë³€ê²½ì‚¬í•­ ì»¤ë°‹ ë° í‘¸ì‹œ
      if: steps.verify-changed-files.outputs.changed == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "AI Blog Bot ðŸ¤–"
        git add -A
        
        # ìƒì„±ëœ í¬ìŠ¤íŠ¸ ì œëª© ì¶”ì¶œ (ì²« ë²ˆì§¸ ë¼ì¸ì—ì„œ)
        if [ -f "posts/"*.md ]; then
          LATEST_POST=$(ls -t posts/*.md | head -n1)
          POST_TITLE=$(head -n1 "$LATEST_POST" | sed 's/# //' | sed 's/^title: "//' | sed 's/"$//')
          COMMIT_MSG="ðŸ¤– AI ìžë™ í¬ìŠ¤íŒ…: $POST_TITLE"
        else
          COMMIT_MSG="ðŸ¤– AI ìžë™ í¬ìŠ¤íŒ… - $(date '+%Y-%m-%d %H:%M:%S')"
        fi
        
        git commit -m "$COMMIT_MSG" -m "- OpenAI GPTë¡œ ìžë™ ìƒì„±ëœ ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸
        - ì›¹ì‚¬ì´íŠ¸ ìžë™ ì—…ë°ì´íŠ¸ ì™„ë£Œ
        - ìƒì„± ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S KST')"
        
        git push
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ðŸ“‹ ì‹¤í–‰ ê²°ê³¼ ìš”ì•½
      run: |
        echo "## ðŸ¤– AI ìžë™ ë¸”ë¡œê·¸ í¬ìŠ¤íŒ… ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "${{ steps.verify-changed-files.outputs.changed }}" == "true" ]; then
          echo "âœ… **ì„±ê³µ**: ìƒˆë¡œìš´ ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸ê°€ ìƒì„±ë˜ì–´ ì›¹ì‚¬ì´íŠ¸ì— ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— **ë¼ì´ë¸Œ ì‚¬ì´íŠ¸**: https://tonyhwang1004.github.io/ai-insight-blog" >> $GITHUB_STEP_SUMMARY
        else
          echo "â„¹ï¸ **ì •ë³´**: ì´ë²ˆ ì‹¤í–‰ì—ì„œëŠ” ìƒˆë¡œìš´ í¬ìŠ¤íŠ¸ê°€ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“… **ì‹¤í–‰ ì‹œê°„**: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
